var zFeedHandler={HANDLER_CODE_GIFT:"gift",HANDLER_CODE_ERROR:"error",HANDLER_CODE_QUEST:"quest",HANDLER_CODE_SUCCESS:"success",HANDLER_CODE_NOOP:"noop",routeResponse:function routeResponse(b,e,a){var c=zFeed.STATUS_SUCCESS;var d=undefined;switch(b){case zFeedHandler.HANDLER_CODE_GIFT:zFeedHandler.handleGiftResponse(e);break;case zFeedHandler.HANDLER_CODE_ERROR:c=zFeed.STATUS_FAILED;break;case zFeedHandler.HANDLER_CODE_NOOP:case zFeedHandler.HANDLER_CODE_SUCCESS:break;case zFeedHandler.HANDLER_CODE_QUEST:zFeedHandler.handleQuestResponse(e);break;default:c=zFeed.STATUS_FAILED;d="";zFeed.log("Invalid handler code: "+b+" Params:");zFeed.log(e)}zFeed.setState(a,c,d)},handleGiftResponse:function handleGiftResponse(a){if(a!=undefined){if(a.itemName!=undefined){if(a.qty==undefined){a.qty=1}zFeedHandler.addItemToGiftbox(a.itemName,a.qty)}else{zFeed.log("No gift item code set")}}else{zFeed.log("Invalid gift payload.")}},handleQuestResponse:function handleQuestResponse(a){if(a!=undefined){if(a.itemName!=undefined){if(a.qty==undefined){a.qty=1}zFeedHandler.addQuestProgressItem(a.itemName,a.qty)}else{zFeed.log("No quest item code set")}}else{zFeed.log("Invalid quest payload.")}},addItemToGiftbox:function addItemToGiftbox(a,b){if(a!=undefined){document.getElementById("flashapp").addItemToGiftbox(a,b)}},addQuestProgressItem:function addQuestProgressItem(a,b){if(a!=undefined){document.getElementById("flashapp").addQuestProgressItem(a,b)}}};var zFeed={STATUS_UPDATING:"updating",STATUS_SUCCESS:"success",STATUS_EXPIRED:"expired",STATUS_FAILED:"failed",STATUS_EXTERNAL:"external",AUTO_LOAD_FEED_COUNT:75,MAX_TITLE_LENGTH:200,ELIPSE:"...",getMoreMaxRetries:0,ZTRACK_SAMPLE_RATE:1,LOADING_TIMEOUT:60000,lastFeedId:0,lastFeedTS:0,numFeedsLoaded:0,maxFeedCount:0,getMoreRetries:0,initialized:false,visible:false,setState:function setState(b,d,f){var c=$("#"+b);var e=$("#feedCompleteStatusText_"+b);var a=$("#feedCompleteStatusIcon_"+b);if(c!=null&&e!=null&&a!=null){switch(d){case zFeed.STATUS_UPDATING:e.css("color","#000");c.css("background-color","#EDF7FF");if(f==undefined){f=""}a.html('<img src="'+getZFeedBaseImageURL()+'zfeed_icon_updating.gif" />');e.html(f);break;case zFeed.STATUS_SUCCESS:e.css("color","#00852A");c.css("background-color","#E0F0E5");if(f==undefined){f="Got it!"}a.html('<img src="'+getZFeedBaseImageURL()+'zfeed_icon_success.png" />');e.html(f);break;case zFeed.STATUS_EXPIRED:e.css("color","#B40000");c.css("background-color","#EAEAEA");if(f==undefined){f="Just missed it!"}a.html('<img src="'+getZFeedBaseImageURL()+'zfeed_icon_failed.png" />');e.html(f);break;case zFeed.STATUS_FAILED:e.css("color","#B40000");c.css("background-color","#EAEAEA");if(f==undefined){f="Just missed it!"}else{if(f==""){f="Refresh the Feed Panel"}}a.html('<img src="'+getZFeedBaseImageURL()+'zfeed_icon_failed.png" />');e.html(f);break;case zFeed.STATUS_EXTERNAL:e.css("color","#00852A");c.css("background-color","#E0F0E5");if(f!=undefined){f='<img class="gameIcon" src="'+f+'" />'}else{f=""}a.html('<img src="'+getZFeedBaseImageURL()+'zfeed_icon_success.png" />');e.html(f);break}}},handleFarmFeedClick:function handleFarmFeedClick(a,b,c,f,d,e){if(zFeed.isEnabled(a)){zFeed.disableFeed(a);zFeed.setState(a,zFeed.STATUS_UPDATING);zFeed.sendClickEvent(a,b,c,f,d,e);zFeed.recordFeedClick(a)}},disableFeed:function disableFeed(a){$("#"+a).attr("disabled","disabled")},isEnabled:function isEnabled(a){var b=$("#"+a);var c=false;if(b){c=b.attr("disabled")!="disabled"}return c},fadeOut:function fadeOut(a){var b=$("#"+a);if(b!=null){b.fadeOut(3000)}},delayedFadeOut:function delayedFadeOut(a,b){setTimeout("zFeed.fadeOut('"+a+"')",b)},addFeedHtml:function addFeedHtml(b){var a=$("#zfeed_list").append(b)},preprocess:function preprocess(a){if(a.body["title"].length>zFeed.MAX_TITLE_LENGTH){a.body["title_short"]=a.body["title"].substring(zFeed.MAX_TITLE_LENGTH)+zFeed.ELIPSE}else{a.body["title_short"]=a.body["title"]}return a},getMore:function getMore(c,d){if(c==undefined){c=0}if(typeof getZFeedUrl=="function"&&typeof zFeedShowAllFeeds!="undefined"){if((c<=zFeed.getMoreMaxRetries)||true){var b=getZFeedUrl();if(ZY&&ZY.PrepareURL){b=ZY.PrepareURL(b)}$("#zfeed_more").css("display","none");$("#zfeed_loading").css("display","block");if($("#zfeednav").length){$("#zfeednav").addClass("feedsloading")}var a={};if(zFeedShowAllFeeds||zFeedLocalAppId==undefined){a={lastFeedTS:zFeed.lastFeedTS,retryNumber:c}}else{a={lastFeedTS:zFeed.lastFeedTS,gameIds:zFeedLocalAppId,retryNumber:c}}if(d!=undefined){a.starttime=d}$.ajax({url:b,data:a,context:document.body,success:function(g){try{zFeed.getMoreRetries=0;$("#zfeed_loading").css("display","none");if($("#zfeednav").length){$("#zfeednav").removeClass("feedsloading")}var k=jQuery.parseJSON(g);var h=k.feedPayloads;var f=k.hasMoreFeeds;d=k.starttime;c=k.retryNumber;if(k.success){var j="";var e="";$.each(h,function(){e=this;zFeed.lastFeedId=e.id;zFeed.lastFeedTS=e.ts;e.id=zFeed.getSafeFeedId(e.id);if($("#"+e.id).length==0){if(zFeed.isValidFeed(e)){zFeed.numFeedsLoaded++;e=zFeed.preprocess(e);j=zFeed.getFeedHTML(e);zFeed.addFeedHtml(j);zFeed.startTimeAgo(e.id)}}});if(f){$("#zfeed_more").css("display","block")}else{$("#zfeed_more").css("display","none")}}else{zFeed.getMore(c,d)}}catch(i){zFeed.log(i)}},complete:function(e,f){if(f!="success"){zFeed.getMoreRetries++;zFeed.getMore(c,d)}}})}else{$("#zfeed_loading").css("display","none")}}},getSafeFeedId:function getSafeFeedId(a){a="zfeed_"+a.replace(":","-");return a},getRealFeedId:function getRealFeedId(a){a=a.replace("_",":");return a},isValidFeed:function isValidFeed(a){if(a.ctas==undefined){return false}if(a.ctas[0]==undefined){return false}if(a.ctas[0]["href"]==undefined){return false}return true},startTimeAgo:function startTimeAgo(a){$("#timeago_"+a).timeago()},sendClickEvent:function sendClickEvent(a,b,c,f,d,e){$.ajax({url:b,context:c,success:function(h){var g=this.getAttribute("feed_id");try{h=h.replace("&nbsp;&nbsp;","");h=h.replace(/<\/?[^>]+(>|$)/g,"");var k=jQuery.parseJSON(h);var j=k.handlerCode;var l=k.params;if(j==undefined){throw"Invalid Response"}else{var m="";if(j!=zFeedHandler.HANDLER_CODE_ERROR){m="success"}else{m="fail"}FarmNS.StatsManager.sample(zFeed.ZTRACK_SAMPLE_RATE,"zfeed",m,f,d,e);if(l==undefined){l=[]}zFeed.updateFlashGame(j,l,g)}}catch(i){zFeed.log(i);zFeed.setState(g,zFeed.STATUS_FAILED,"")}zFeed.delayedFadeOut(g,3000)},complete:function(h,i){if(i!="success"){var g=this.getAttribute("feed_id");zFeed.setState(g,zFeed.STATUS_FAILED)}}})},handleExternalFeedClick:function handleExternalFeedClick(a,b,c){if(zFeed.isEnabled(a)){zFeed.disableFeed(a);$("#external_game_name_"+a).css("display","block");zFeed.setState(a,zFeed.STATUS_EXTERNAL,c);zFeed.recordFeedClick(a);window.open(b);self.focus();setTimeout("zFeed.fadeExternalFeed('"+a+"')",3000)}},recordFeedClick:function recordFeedClick(a){if(typeof getZFeedUrl=="function"){var c=getZFeedUrl();var b={action:"zfeedclick",feedId:a};if(ZY&&ZY.PrepareURL){c=ZY.PrepareURL(c)}$.ajax({url:c,data:b,context:document.body,success:function(d){}})}},fadeExternalFeed:function fadeExternalFeed(a,b){if(b==undefined){b=3000}zFeed.delayedFadeOut(a,b)},getFarmFeedClickLink:function getFarmFeedClickLink(d,c){var e=zFeed.sanitizeTracking(d.metadata["gameName"]);var b=zFeed.sanitizeTracking(d.ctas[0]["text"]);c=zFeed.sanitizeTracking(c);var a='<a href="#" onclick="zFeed.handleFarmFeedClick(\''+d.id+"', '"+d.ctas[0]["href"]+"', this, '"+e+"', '"+b+"', '"+c+"');";a+="FarmNS.StatsManager.sample("+zFeed.ZTRACK_SAMPLE_RATE+", 'zfeed','click', zFeed.sanitizeTracking('farmville'), zFeed.sanitizeTracking('"+d.ctas[0].text+"'), zFeed.sanitizeTracking('"+c+"'));";a+=' return false;" no_auth="true" feed_id="'+d.id+'" title="'+d.body["title"]+'">';return a},getExternalFeedClickLink:function getExternalFeedClickLink(d,c){var e=zFeed.sanitizeTracking(d.metadata["gameName"]);var b=zFeed.sanitizeTracking(d.ctas[0]["text"]);c=zFeed.sanitizeTracking(c);var a='<a href="'+d.ctas[0]["href"]+'" target="_blank" onclick="zFeed.handleExternalFeedClick(\''+d.id+"', '"+d.ctas[0]["href"]+"', '"+d.metadata["gameIconSrc"]+"');";a+="FarmNS.StatsManager.sample("+zFeed.ZTRACK_SAMPLE_RATE+", 'zfeed','click', '"+e+"', '"+b+"', '"+c+"');";a+="FarmNS.StatsManager.sample("+zFeed.ZTRACK_SAMPLE_RATE+", 'zfeed','success', '"+e+"', '"+b+"', '"+c+"');";a+=' return false;" no_auth="true" title="'+d.body["title"]+'">';return a},getFeedAnchorTag:function getFeedAnchorTag(c,b){var a="";if(c.isFarmFeed){a=zFeed.getFarmFeedClickLink(c,b)}else{a=zFeed.getExternalFeedClickLink(c,b)}return a},getFeedHTML:function getFeedHTML(a){var b="<li>";b+='<div class="feed" id="'+a.id+'">';b+='	<div class="feedInner">';b+='		<div class="feedPaddingLeft" style="float:left"></div>';b+='		<div class="feedImage" style="float:left">'+zFeed.getFeedAnchorTag(a,"pic")+'<img src="'+a.image["src"]+'" class="feedImage" /></a></div>';b+='		<div class="feedBody" style="float:left">';b+='			<div class="feedBodyTop">';b+='				<div class="feedProfileImage" style="float:left"><img src="'+a.profile["image"]+'" class="feedProfileImage" /></div>';b+='				<div class="feedBodyContent" style="float:left">';b+='					<div class="feedUserName">'+a.profile["name"]+"</div>";b+='					<div class="feedTitle">'+zFeed.getFeedAnchorTag(a,"link_top")+a.body["title_short"]+"</a></div>";b+="				</div>";b+='				<div style="clear:both"></div>';b+="			</div>";b+='			<div class="feedBodyBottom">';b+='				<div class="feedCtaWrapper" style="float:left">';b+='					<div class="feedCTAs">';b+='						<div class="feedGameIcon" style="float:left"><img class="gameIcon" src="'+a.metadata["gameIconSrc"]+'"></div>';b+='						<div class="feedLink" style="float:left">'+zFeed.getFeedAnchorTag(a,"action_text")+a.ctas[0]["text"]+"</a></div>";b+='						<div style="clear:both"></div>';b+="					</div>";b+='					<div class="feedPostTime" class="float:left"><abbr class="timeago" id="timeago_'+a.id+'"" title="'+a.utc_ts+'"></abbr> via '+a.metadata["gameName"]+"</div>";b+="				</div>";b+='				<div class="feedCompletionStatus" id="feedCompleteStatus_'+a.id+'" style="float:left">';b+='					<div class="feedStatusText" id="feedCompleteStatusText_'+a.id+'" style="float:left"></div>';b+='					<div class="feedStatusIcon" id="feedCompleteStatusIcon_'+a.id+'" style="float:left"></div>';b+='					<div class="feedExternalGameName" style="float:left" id="external_game_name_'+a.id+'">'+a.metadata["gameName"]+"!</div>";b+='					<div style="clear:both"></div>';b+="				</div>";b+='				<div style="clear:both"></div>';b+="			</div>";b+="		</div>";b+='		<div class="feedPaddingRight" style="float:left"></div>';b+='		<div style="clear:both"></div>';b+="	</div>";b+="</div>";b+="</li>";return b},sanitizeTracking:function sanitizeTracking(b){var a=b.replace(" ","_");a=a.toLowerCase();a=a.replace(/[^a-zA-Z_]/gi,"");return a},updateFlashGame:function updateFlashGame(b,c,a){zFeedHandler.routeResponse(b,c,a)},onPostInit:function onPostInit(){$("#zfeed_container_loading").css("display","none");zFeed.setVisibility(true)},setVisibility:function setVisibility(a){if(a!=false){a=true}if(a){$("#zfeed_innerContainer").css("display","block")}else{$("#zfeed_innerContainer").css("display","none")}zFeed.visible=a},activateAllTab:function activateAllTab(){if(!($("#zfeednav").hasClass("feedsloading"))){zFeedShowAllFeeds=true;zFeed.lastFeedTS=0;$("#zfeed_list").empty();$("#zfeedalltab").removeClass("zfeednav_inactive");$("#zfeedalltab").addClass("zfeednav_active");$("#zfeedalltab").html("All Activity");$("#zfeedfarmtab").removeClass("zfeednav_active");$("#zfeedfarmtab").addClass("zfeednav_inactive");$("#zfeedfarmtab").html('<a href="#" onclick="zFeed.activateFarmTab(); return false;">FarmVille Activity</a>');zFeed.getMore()}},activateFarmTab:function activateFarmTab(){if(!($("#zfeednav").hasClass("feedsloading"))){zFeedShowAllFeeds=false;$("#zfeed_list").empty();zFeed.lastFeedTS=0;$("#zfeedfarmtab").removeClass("zfeednav_inactive");$("#zfeedfarmtab").addClass("zfeednav_active");$("#zfeedfarmtab").html("FarmVille Activity");$("#zfeedalltab").removeClass("zfeednav_active");$("#zfeedalltab").addClass("zfeednav_inactive");$("#zfeedalltab").html('<a href="#" onclick="zFeed.activateAllTab();return false;">All Activity</a>');zFeed.getMore()}},log:function log(a){safeConsoleLog(a)},initialize:function initialize(b,a,c){zFeed.lastFeedId=0;zFeed.lastFeedTS=0;zFeed.numFeedsLoaded=0;zFeed.maxFeedCount=0;zFeed.getMoreMaxRetries=c;$("#zfeed_list").html("");zFeed.maxFeedCount=b;zFeed.initialized=true;setTimeout(zFeed.loadingFailsafe,zFeed.LOADING_TIMEOUT);zFeed.delayedLoad(a)},delayedLoad:function delayedLoad(a){zFeed.getMore(undefined,undefined)},loadingFailsafe:function loadingFailsafe(){if(!zFeed.visible){zFeed.onPostInit();FarmNS.StatsManager.sample(zFeed.ZTRACK_SAMPLE_RATE,"zfeed","spinner","timed_out")}},reInitialize:function reInitialize(){zFeed.refresh(zFeed.maxFeedCount)},refresh:function initialize(b,a,c){zFeed.lastFeedId=0;zFeed.lastFeedTS=0;zFeed.numFeedsLoaded=0;zFeed.maxFeedCount=0;zFeed.getMoreMaxRetries=c;$("#zfeed_list").html("");zFeed.maxFeedCount=b;zFeed.initialized=true;setTimeout(zFeed.loadingFailsafe,zFeed.LOADING_TIMEOUT);zFeed.delayedRefreshLoad(a)},delayedRefreshLoad:function delayedLoad(a){zFeed.getMore(undefined,undefined)}};var refreshEveryFiveMinute=setInterval(zFeed.reInitialize,300000);