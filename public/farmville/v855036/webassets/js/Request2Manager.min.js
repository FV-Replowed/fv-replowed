if(typeof(FarmNS)==="undefined"){FarmNS={}}Function.prototype.defaultParams=function(){var b=this;var a=Array(b.length-arguments.length).concat(Array.prototype.slice.apply(arguments));return function(){return b.apply(b,Array.prototype.slice.apply(arguments).concat(a.slice(arguments.length,a.length)))}};FarmNS.GlobalStorage=function(){var f=undefined;var a=undefined;var e="unknown";var g=function(m,n){var l=false;j();if(f!==undefined){f[m]=n;l=true}return l};var k=function(m){var l=false;j();if(f!==undefined){delete f[m];l=true}return l};var c=function(m){var l=false;j();if(f!==undefined&&typeof(f[m])!="undefined"){l=f[m]}return l};var h=function(){var l=false;if(f!==undefined&&f.isStorageInit!==undefined&&f.isStorageInit[e]!==undefined){l=f.isStorageInit[e]}return l};var d=function(){if(e=="unknown"){if(typeof(self)!="undefined"&&typeof(self.name)!="undefined"){e=self.name}}};var j=function(n){if(!h()){d();var m,l=undefined;try{if(typeof(n)!="undefined"){if(typeof(n.document)!="undefined"&&typeof(n.document.domain)!="undefined"){m=n.document.domain}if(m!==undefined&&typeof(n.window)!="undefined"){l=n.window}}}catch(o){}if(m!==undefined&&m=="farmville.com"){a=l;j(n.parent)}else{if(typeof(a)!="undefined"){if(typeof(a.FarmStorage)=="undefined"){a.FarmStorage={isStorageInit:{}}}a.FarmStorage.isStorageInit[e]=true;f=a.FarmStorage}}}}.defaultParams(self);var b=function(){return a};return{get:c,set:g,unset:k,getStorageReferenceDOMWindow:b}}();FarmNS.StatsManager=function(){var e=false;var k=window.g_requestStatsBatching;var l=[];var a=null;var f=false;var g={COUNT:"count",SAMPLE:"sample"};var j=5000;var m=50;var h=function(o,p,v,r,s,x,w,u){if(e){if(k==0){var t=e+"&call=count&counter="+o+"&kingdom="+p+"&phylum="+v+"&class="+r+"&family="+s+"&genus="+x;if(w){t=t+"&value="+w}if(u){t=t+"&errorLog="+escape(u)}$.ajax({type:"POST",url:"stats_counter.php",data:t,cache:false})}else{var q={count:o,k:p,p:v,c:r,f:s,g:x,v:w,e:u};d(g.COUNT,q)}}}.defaultParams("","","","","",1,"");var b=function(u,o,p,w,r,s,y,x,v){if(e){if(k==0){var t=e+"&call=sample&rate="+u+"&counter="+o+"&kingdom="+p+"&phylum="+w+"&class="+r+"&family="+s+"&genus="+y;if(x){t=t+"&value="+x}if(v){t=t+"&errorLog="+escape(v)}$.ajax({type:"POST",url:"stats_counter.php",data:t,cache:false})}else{var q={r:u,count:o,k:p,p:w,c:r,f:s,g:y,v:x,e:v};d(g.SAMPLE,q)}}}.defaultParams("","","","","","",1,"");var c=function(r,p,o,q){if(e){var s=e+"&call=messageSendKey&sendKey="+r;if(q){s=s+"&errorLog="+escape(q)}$.ajax({type:"POST",url:"stats_counter.php",data:s,cache:false})}}.defaultParams("","","");var d=function(p,o){var q={t:p,a:o,time:+new Date()};l.push(q);clearTimeout(a);if(l.length>=m){n()}else{a=setTimeout(n,j)}};var n=function(){var t=e&&!f;var r=false;if(!t){clearTimeout(a);a=setTimeout(n,j);r=true}if(!r){a=null;if(l.length===0){r=true}}if(!r){f=true;var q=+new Date();var o=l;l=[];var p=JSON.stringify(o);var s=e+"&batch="+encodeURIComponent(p)+"&time="+q;var v=function(w){f=false};var u=function(){f=false};$.ajax({type:"POST",url:"stats_batch.php",data:s,cache:false,success:function(x,y,w){v(x)},error:function(w,y,x){u()}})}};return{count:h,sample:b,messageSendKey:c,bufferAndQueueCall:d,monitorStatsQueue:n,setAuth:function(o){e=o},getAuth:function(){return e}}}();FarmNS.Request2Manager=function(){var d=false;var A=false;var F=false;var I=false;var y=false;var L=0;var t=0;var b=false;var o={posted:"posted",closed:"closed",canceled:"skipped",unknown:"unknown",error:"error"};var z=function(N,O){var M=function(){if(O!=null){O()}};if(N.authResponse){I=N.authResponse;M()}else{if(N.session){F=N.session;M()}else{y=false;FarmNS.StatsManager.count("oauth_trial","session_info","fv_sessionclosed");FB.login(function(P){if(P.session){F=P.session;y=true;FarmNS.StatsManager.count("oauth_trial","session_info","fv_session_reopened");M()}else{FarmNS.StatsManager.count("oauth_trial","session_info","fv_session_reload");window.location.reload()}})}}}.defaultParams(null);var q=function(N,O){var M=function(){if(O!=null){O()}};if(N.authResponse){I=N.authResponse;M()}else{if(N.session){F=N.session;M()}else{e(false);FarmNS.StatsManager.count("oauth_trial","session_info","fv_sessionclosed");FB.login(function(P){if(P.session){F=P.session;e(true);FarmNS.StatsManager.count("oauth_trial","session_info","fv_session_reopened");M()}else{if(P.authResponse){F={signed_request:P.authResponse.signedRequest,access_token:P.authResponse.accessToken,data_access_expiration_time:P.authResponse.data_access_expiration_time,expires_in:P.authResponse.expiresIn,};e(true);FarmNS.StatsManager.count("oauth_trial","session_info","fv_session_reopened");M()}else{FarmNS.StatsManager.count("oauth_trial","session_info","fv_session_reload")}}})}}}.defaultParams(null);var c=function(N,M){FB.getLoginStatus(function(O){if(typeof(M)!="undefined"&&M===true){q(O,N)}else{z(O,N)}})}.defaultParams(null,false);var m=function(N,M,O,P,Q){c(function(){l(N,M,O,P,Q)})};var l=function(P,O,Q,R,S){var M=function(T){if(FarmNS.FORCE_HIDE_FB_REQ_DIALOG&&FarmNS.FORCE_HIDE_FB_REQ_DIALOG==true){var U=document.getElementsByClassName("fb_dialog_advanced");for(var V=0;V<U.length;V++){U[V].style.top="-10000px"}}S(T,F)};var N;if(typeof(FarmNS)!="undefined"&&FarmNS.FB_REQ_MODE_POPUP!=undefined&&FarmNS.FB_REQ_MODE_POPUP){N="popup"}else{if(FarmNS.USE_FB_MODAL_DIALOG===undefined||FarmNS.USE_FB_MODAL_DIALOG===false){N="iframe"}}if("undefined"!=typeof(R)&&R&&R.length>0){FB.ui({method:"apprequests",to:R,message:O,data:P,title:Q},M)}else{FB.ui({method:"apprequests",message:O,data:P,title:Q,display:N},M)}};var r=function x(R,P,M,Q){if(typeof(R)==="function"){try{R();FarmNS.StatsManager.sample(100,M,P,"success",P+"IsExecuted")}catch(O){var N="";if(O.message!=undefined&&O.message!=""){N=O.message}if(Q===true){showFarmFeedIssueFailureReportWindow(N)}FarmNS.StatsManager.sample(100,M,P,"error",P+"IsNotExecuted",N)}}else{FarmNS.StatsManager.sample(100,M,P,"error",P+"IsNotExecuted")}}.defaultParams(null,"unknown","defaultSafeTryCatchCounter",false);g:function g(M,O,N){var Q="";if(M&&(M.request&&M.to)){var P=M.request;requestIds=P+"_"+M.to[0];Q="requestIds="+requestIds;Q=Q+"&action=singleRequestSend";if(O){Q=Q+"&access_token="+O.access_token;Q=Q+"&expires="+O.expires}if(N){N=JSON.parse(N);Q=Q+"&itemCode="+N[1]}}return Q}var j=function j(M){FarmNS.Request2Manager.syncInitFB2(b);if(!G()){if(M>0){M--;FarmNS.Request2Manager.retrySyncInitFB(M)}}}.defaultParams(1);var n=function n(M){j();if(G()){M()}};var G=function G(){return FarmNS.GlobalStorage.get("isFbInit")};var p=function p(){return FarmNS.GlobalStorage.get("isFbAllJsDownload_"+self.name)};var e=function e(M){FarmNS.GlobalStorage.set("isFbInit",M);FarmNS.GlobalStorage.set("fbInitBy",self.name);y=FarmNS.GlobalStorage.get("isFbInit")}.defaultParams(false);var H=function H(){return FarmNS.GlobalStorage.get("initializedFbObject")};var h=function B(N){var M=false;var O=H();if(typeof(O)!=="object"){M=FarmNS.GlobalStorage.set("initializedFbObject",N);if(M!==false){var P=FarmNS.GlobalStorage.getStorageReferenceDOMWindow();if(P!==undefined){P.FB=N}}}return M};var f=function f(M){FarmNS.GlobalStorage.set("isFbAllJsDownload_"+self.name,M)}.defaultParams(false);var u=function u(N,M){if(!p()||N){v(M)}else{if(window.fbAsyncInit&&!window.fbAsyncInit.hasRun){}}}.defaultParams(false,false);var v=function v(M){var O=document.createElement("script");if(M!==false&&M!==""){O.src=M}else{O.src="//connect.facebook.net/en_US/all.js";var N=true;if(typeof(Farm)!="undefined"&&Farm.JS_SDK_V2==false){N=false}if(N){O.src="//connect.facebook.net/en_US/sdk.js"}}O.async=true;document.getElementById("fb-root").appendChild(O)}.defaultParams(false);var C=function C(M){var N=E(M);if(document.getElementById("flashapp")){if(document.getElementById("flashapp").fbPermissionRequestPostAction){document.getElementById("flashapp").fbPermissionRequestPostAction(N)}}};var E=function E(N){var M={action:"unknown",requestSuccess:false,data:{}};if(typeof(N)=="undefined"){M.action=o.closed}else{if(typeof(N)=="object"){if(N.perms==""){M.action=o.canceled}else{var O=N.perms.split(",");if(typeof(O)=="object"&&O.length>0){for(i in O){M.data[O[i]]=1}M.action=o.posted;M.requestSuccess=true}}}}return M};var K={"gifts_send.tpl":true,"askcollectible.tpl":true,"neighbors.tpl":true,"invite.tpl":true,"gifts.tpl":true,"unclaimedRewards.tpl":true};var D=function D(N){var M=false;if(typeof(N)!="undefined"&&N){if(typeof(K[N])!="undefined"&&K[N]){M=true}}return M};return{addInitAction:function(M){if(y){M()}if("undefined"!=typeof(A)&&false!=A){var N=A;A=function(){N();M()}}else{A=M}},syncInitFB:function(M){if(b===false){b=M}var N=true;if(typeof(FarmNS)!=="undefined"&&FarmNS.FB_FRICTIONLESS_REQ_ENABLED==false){N=false}FB.init({appId:M,status:true,cookie:true,xfbml:true,frictionlessRequests:N,version:"v3.3",oauth:true});c(null);y=true;FB.Event.subscribe("auth.sessionChange",function(O){z(O)});if("undefined"!=typeof(A)&&A!=false){A()}},initFB:function(M){window.fbAsyncInit=function(){FarmNS.Request2Manager.syncInitFB(M)};v()},syncInitFB2:function(M,O){if(!G()||O){if(b===false){b=M}var N=true;if(typeof(FarmNS)!=="undefined"&&FarmNS.FB_FRICTIONLESS_REQ_ENABLED==false){N=false}FB.init({appId:M,status:true,cookie:true,xfbml:true,frictionlessRequests:N,version:"v3.3",oauth:true});c(function(){e(true)},true);FB.Event.subscribe("auth.sessionChange",function(P){q(P)});if("undefined"!=typeof(A)&&A!=false){A()}}else{}}.defaultParams("",false),initFB2:function(M,P,N){var O=false;if(typeof(P)!="undefined"&&P){O=D(P)}window.fbAsyncInit=function(){f(true);if(!G()||O){FarmNS.Request2Manager.syncInitFB2(M,O)}else{}};u(O,N)}.defaultParams("",false,false),shareAsFbLink:function(M){var N={method:"/me/links/",display:"dialog",link:M.shareLink,title:M.attachment.name,icon:M.attachment.media[0]["src"]};var O=function(P){FarmNS.StatsManager.sample(100,"link_share","popup_response",JSON.stringify(P))};FB.api("/me/links/","post",N,O)},sendRequestsFromFlash:function(N,M,O,P,Q){ZYFrameManager.showScreenshot();var R=function(S,T){if(S&&(S.request&&S.to)){FarmNS.StatsManager.count("Reqs2_recently_played","request_send_success",Q);var V=S.request;var W={};W.request_ids=new Array();for(var U=0;U<S.to.length;U++){W.request_ids[U]=V+"_"+S.to[U]}}else{FarmNS.StatsManager.count("Reqs2_recently_played","request_send_fail");FarmNS.Request2Manager.refreshFriends()}ZYFrameManager.hideScreenshot();document.getElementById("flashapp").fbresponseHandler(W)};m(N,M,O,P,R)},shareFarmstamaticPhoto:function k(M,N){FB.api("photos","post",{message:N,url:M},function(O){document.getElementById("flashapp").sharePhotoResponseHandler(O)})},sendRequestsFromJS:function w(N,M,O,S,R,P,Q){var T=function(U,V){if(U&&(U.request&&U.to)){FarmNS.StatsManager.count(R,"request_send_success",R);var W=g(U,V,N);W=W+"&"+P;var X=jQuery.parseJSON(N);if(X!==undefined&&X[Q]!==undefined&&X.length!==undefined&&X.length>Q&&Q>0){W=W+"&ts="+X[Q]}$.ajax({type:"POST",url:"gifts_send.php",data:W,cache:false,dataType:"text",complete:function(Y){if(Y.status=="200"){FarmNS.StatsManager.count(R,"success","requestSent")}else{FarmNS.StatsManager.count(R,"error","cannotSendAjax")}window.top.location.href="index.php"}})}else{FarmNS.StatsManager.count(R,"request_send_fail");FarmNS.Request2Manager.refreshFriends()}};m(N,M,O,S,T)}.defaultParams({},"","",[],"","",0),refreshFriends:function J(){var M="populateFbCache.php?"+FarmNS.StatsManager.getAuth()+"&action=forceRefresh";$.ajax({type:"POST",url:M,cache:false,context:document.body,success:function(N){FarmNS.StatsManager.count("refreshFriends","success")},error:function(P,N,O){FarmNS.StatsManager.count("refreshFriends","error",N,O)}})},onFlashCrash:function s(){var M="stats_counter.php?"+FarmNS.StatsManager.getAuth()+"&action=flashCrash";$.ajax({type:"POST",url:M,cache:false,})},permissionRequest:function a(M){c(function(){if(typeof(M)=="undefined"||M==""){FarmNS.StatsManager.sampleAS(100,"Request2Manager","permissionRequest","error","permissionsAreNotProvided");return}var N={method:"permissions.request",perms:M,display:"popup"};FB.ui(N,C)})},isInitialized:function(){return y},sendAppRequests:m}}();FarmNS.GiftsSendManagerFactory=function(r,l){var d={};var j=[];var g={};var b=[];var f=[];var n=function(v){var u=false;if("undefined"!=typeof(d[v])){u=d[v];u=u.name}if("string"==typeof(u)){u=jQuery.trim(u)}if("string"!=typeof(u)||u.length<1){u=false}return u};var c=function(v){var u=false;if("undefined"!=typeof(d[v])){var w=d[v];if("undefined"!=typeof(w.last_name)){u=w.last_name}}if("string"==typeof(u)){u=jQuery.trim(u)}if("string"!=typeof(u)||u.length<1){u=false}return u};var s=function(w,v){var y=n(w);var x=n(v);var u=0;if(y<x){u=-1}if(y>x){u=1}return u};for(var p=0;p<r.length;p++){var m=r[p];var e=m.uid;var t=m.name;d[e]=m;j.push(e)}g=l;var k=function(){return f.slice(0)};var a=function(u){for(var v in g){index=$.inArray(u,g[v]);if(index>=0){g[v].splice(index,1)}}index=$.inArray(u,b);if(index>=0){b.splice(index,1)}index=$.inArray(u,f);if(index>=0){f.splice(index,1)}};var o=function(u){FarmNS.StatsManager.count("reqs2_custommfs_exp","errors","Request2Manager","request2send_post_error","","",1,u)};var h=function(u){FarmNS.StatsManager.count("reqs2_custommfs_exp","errors","Request2Manager","request2send_retry_success","","",1,u)};var q=function(w,D,v,u,C){if(w&&(w.request_ids||(w.request&&w.to))){var A=k();var z=A.length;for(var x=0;x<A.length;x++){a(A[x])}if(w.request&&w.to){var E=w.request;requestIds=w.to.join(","+E+"_");requestIds=E+"_"+requestIds}else{requestIds=w.request_ids.join(",")}var y="action=Request2Send&requestIds="+requestIds+"&"+v;if(u){y=y+"&access_token="+u.access_token;y=y+"&expires="+u.expires}var B=new Date();m_onSendTime=B.getTime();$.ajax({type:"POST",url:"gifts_send.php",data:y,cache:false,dataType:"text",complete:function(H){if(H.status!="200"){o("response code:"+H.status+" on POST to gifts_send.php with data: "+y+" responseText: "+H.responseText);if(C<2){q(w,D,v,u,C+1)}}else{var F=new Date();m_onSentTime=F.getTime();var G=Math.round((m_onSentTime-m_onSendTime)/100);var G=G/10;if(G>30){G=30}FarmNS.StatsManager.count("reqs2_custommfs_exp","fv_gifts_send_perf_sec",z,G);if(C>0){h("POST to gifts_send.php succeeded on retry "+C)}D(w)}}})}else{D(null)}}.defaultParams(false,0);return{getFriendName:n,getFriendLastName:c,getSelected:k,sortSelectable:function(){b.sort(s)},getSelectable:function(){return b.slice(0)},getAllFriendIds:function(){return j},resetSelected:function(u){if(g.hasOwnProperty(u)){f=[];b=g[u].slice(0);this.sortSelectable()}},selectUser:function(v){var u=$.inArray(v,b);if(u>=0){f.push(v);b.splice(u,1)}},unselectUser:function(v){var u=$.inArray(v,f);if(u>=0){b.push(v);f.splice(u,1);b.sort(s)}},removeUser:a,sendRequests:function(w,v,x,A,u,y,z){var B=function(C,D){A();q(C,u,y,D)};FarmNS.Request2Manager.sendAppRequests(w,v,x,f,B)}}};