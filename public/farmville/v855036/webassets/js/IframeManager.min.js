if(typeof(FarmNS)==="undefined"){FarmNS={}}FarmNS.IframeManager=function(){var e="farmvilleIframe";var i="farmvilleIframeProxy";var d="farmvilleIframeProxyParent";var f="flashAppIframe";var h="iframe_communication_proxy.php";var j="iframe_communication_parent_proxy.php";var a={};var c={height:"0",tiered_gift:"1",starterPackPaymentEmbed:"2",starterPackPaymentInst:"3",newInGamePayment:"4",starterPackPayment:"5",low_cash_add_to_cart:"6",hideFlash:"7",low_cash_complete:"8",starterPackPaymentComplete:"9",starterPackPaymentInstComplete:"10",starterPackPaymentInstStart:"11",tierEnd:"12",newInGameEnd:"13"};var b=function(l){var o=new Array();var m=l.split(/&/);for(var k=0;k<m.length;k++){var n=m[k].split(/=/);o[n[0]]=n[1]}return o};var g=function(m,n){var k=false;if(n[m]!==null&&n[m]!==undefined){var l=this.getMessageType(m);var o=this.getLastTimestampKey(l);if(n[o]!==undefined){if(!((a[o]!==undefined)&&(a[o]===n[o]))){a[o]=n[o];k=true}}}return k};return{lastTimestampKey:"last_ts",getLastTimestampKey:function(k){return k+this.lastTimestampKey},getMessageType:function(k){return c[k]},appendToken:function(l,n){var k=this.getLastTimestampKey(l);var m=Math.round(new Date().getTime()/1000);return n+"&"+k+"="+m},currentParameters:undefined,onMessageFromChild:function(m){if(m.length>0){var l=b(m);var n;var k;if(l.height!==null&&l.height!==undefined){this.reSizeIframe(l.height)}if(g.call(this,"tiered_gift",l)){tiered_gift(l.uid,l.purchaseId,l.amount,l.ref)}if(g.call(this,"starterPackPaymentEmbed",l)){starterPackPaymentEmbed(l.uid,l.purchaseId,l.appId)}if(g.call(this,"starterPackPaymentInst",l)){starterPackPaymentInst(l.uid,l.purchaseId,l.appId,l.paymentRef)}if(g.call(this,"newInGamePayment",l)){newInGamePayment(l.uid,l.purchaseId,l.amount,l.ref,l.appId)}if(g.call(this,"starterPackPayment",l)){starterPackPayment(l.uid,l.purchaseId,l.ref,l.appId)}if(g.call(this,"low_cash_add_to_cart",l)){low_cash_add_to_cart(l.gameId,l.snId,l.uid,l.clientId,l.grantCode,l.amount,l.ref,l.appId,l.callbackId,l.overrideTitle,l.overrideDescription,l.overrideImage)}}},onMessageFromParent:function(n){if(n.length>0){var m=b(n);var o;var l;if(g.call(this,"hideFlash",m)){hideFlash()}if(g.call(this,"low_cash_complete",m)){showFlash();callbackId=m.callbackId;fbResponse={};if(m.order_id!==null&&m.order_id!==undefined){fbResponse.order_id=m.order_id}if(m.status!==null&&m.status!==undefined){fbResponse.status=m.status}if(m.error_code!==null&&m.error_code!==undefined){fbResponse.error_code=m.error_code}if(m.error_message!==null&&m.error_message!==undefined){fbResponse.error_message=m.error_message}FarmNS.getFlash().doRegisteredCallback(callbackId,fbResponse)}if(g.call(this,"starterPackPaymentComplete",m)){showFlash();order_id=m.order_id;document.getElementById("flashapp").inGamePackPaymentEnd(order_id);document.getElementById("flashapp").refreshBalance();document.getElementById("flashapp").refreshBuyerPromo();refreshGifts()}if(g.call(this,"starterPackPaymentInstComplete",m)){fbResponse={};if(m.order_id!==null&&m.order_id!==undefined){fbResponse.order_id=m.order_id}if(m.status!==null&&m.status!==undefined){fbResponse.status=m.status}if(m.error_code!==null&&m.error_code!==undefined){fbResponse.error_code=m.error_code}if(m.error_message!==null&&m.error_message!==undefined){fbResponse.error_message=m.error_message}window.frames.farmvilleInnerIframe.onBuyStarterPackEnd(fbResponse)}if(g.call(this,"starterPackPaymentInstStart",m)){window.frames.farmvilleInnerIframe.onBuyStarterPackStart()}if(g.call(this,"tierEnd",m)){showFlash();$("#saleDialog").hide();var k=document.getElementById("flashapp");if(k.refreshBalance&&k.refreshGifts&&k.refreshBuyerPromo&&k.inGamePaymentEnd){k.refreshBalance();k.refreshGifts();k.refreshBuyerPromo();order_id=m.order_id;k.inGamePaymentEnd(order_id)}else{$.ajax({type:"POST",url:Farm.StatsURL+"&counter=tieredGiftsSale&kingdom=force_refresh",complete:function(q,p){top.location.href=Farm.FB_APP_URL+"index.php"}})}}if(g.call(this,"newInGameEnd",m)){showFlash();var k=document.getElementById("flashapp");if(k){k.refreshBalance();order_id=m.order_id;k.inGamePaymentEnd(order_id)}}}},forwardMessage:function(){var l=document.location.hash;if((l!==undefined)&&(l.length>0)){l=l.substr(1);try{if(parent.parent.iframeManager!==undefined){parent.parent.iframeManager.onMessageFromChild(l)}}catch(k){}}},sendMessageToParent:function(n){var m=document.getElementById(i);if((m!==undefined)&&(m!==null)){var o={};var l;if(this.currentParameters!==undefined){o=this.currentParameters}if(n.length>0){l=b(n);for(var q in l){if(l.hasOwnProperty(q)){o[q]=l[q]}}var k="";for(var q in o){if(o.hasOwnProperty(q)){k+=q+"="+o[q]+"&"}}if(k!==""){n=k}this.currentParameters=o}m.contentWindow.location=Farm.APP_FB_PROXY_URL+h+"#"+n;m.width=m.width>50?50:55}},forwardMessageToChild:function(){var l=document.location.hash;if((l!==undefined)&&(l.length>0)){l=l.substr(1);try{if(parent.frames[f].iframeManager!==undefined){parent.frames[f].iframeManager.onMessageFromParent(l)}}catch(k){}}},sendMessageToChild:function(l){var k=document.getElementById(d);if((k!==undefined)&&(k!==null)){k.contentWindow.location=Farm.APP_IFRAME_URL+j+"#"+l;k.width=k.width>50?50:55}},reSizeIframe:function(k){try{var l=document.getElementById(e);if((l!==undefined)&&(l!==null)){k=parseInt(k);if(k>4000){k=""+k+"px";if(l.style.height!==k){l.style.height=k}}}}catch(m){}},bodySizeChanged:function(){var k="height=";if(document.body.scrollHeight){k=k+document.body.scrollHeight}else{k=k+document.documentElement.offsetHeight}this.sendMessageToParent(k)}}};